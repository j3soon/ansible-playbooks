- name: Setup development environment
  hosts: dev
  tasks:
    - name: Remove `Connect Your Online Accounts` popup
      become: true
      apt:
        name: gnome-initial-setup
        state: absent
      register: remove_gnome_initial_setup
    - name: Killall `Connect Your Online Accounts` popup
      become: true
      shell: killall gnome-initial-setup
      ignore_errors: true  # In case the process is not running
      when: remove_gnome_initial_setup.changed
    - name: Remove `Upgrade Available` popup
      become: true
      apt:
        name: ubuntu-release-upgrader-core
        state: absent
      register: remove_ubuntu_release_upgrader_core
    - name: Killall `Upgrade Available` popup
      become: true
      shell: killall check-new-release-gtk
      ignore_errors: true  # In case the process is not running
      when: remove_ubuntu_release_upgrader_core.changed
    - name: Set locale to en_US
      become: true
      copy:
        dest: /etc/default/locale
        content: |
          # File generated by update-locale
          LANG="en_US.UTF-8"
          LC_NUMERIC="en_US.UTF-8"
          LC_TIME="en_US.UTF-8"
          LC_MONETARY="en_US.UTF-8"
          LC_PAPER="en_US.UTF-8"
          LC_NAME="en_US.UTF-8"
          LC_ADDRESS="en_US.UTF-8"
          LC_TELEPHONE="en_US.UTF-8"
          LC_MEASUREMENT="en_US.UTF-8"
          LC_IDENTIFICATION="en_US.UTF-8"
        owner: root
        group: root
        mode: '0644'
      register: set_locale
    - name: Install common tools
      become: true
      apt:
        name:
          - curl
          - git
          - htop
          - iputils-ping
          - nano
          - net-tools
          - python3-pip
          - tmux
          - tree
          - unzip
          - vim
          - wget
          - zip
        state: present
        update_cache: yes
    - name: Install psutil for `dconf`
      pip:
        name: psutil
        state: present
    - name: Set GNOME favorite apps
      dconf:
        key: /org/gnome/shell/favorite-apps
        value: "['firefox_firefox.desktop', 'org.gnome.Nautilus.desktop', 'org.gnome.Terminal.desktop', 'org.gnome.gedit.desktop']"
        state: present
    - name: Upgrade apt packages
      become: true
      apt:
        upgrade: yes
        update_cache: yes
        cache_valid_time: 86400
    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required_file
    - name: Reboot if required
      become: true
      reboot:
      when: reboot_required_file.stat.exists == true or set_local.changed
